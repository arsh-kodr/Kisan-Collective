{
  "info": {
    "name": "Kisan Collective API (Full with Payments)",
    "_postman_id": "merged-collection-1234",
    "description": "Postman collection for testing all routes of Kisan Collective backend (Auth, User, Listings, Lots, Bids, Payments with Razorpay) with automated token and ID management",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Health Check",
      "request": {
        "method": "GET",
        "header": [],
        "url": "{{base_url}}/api/health"
      }
    },
    {
      "name": "Auth",
      "item": [
        {
          "name": "Register Farmer",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "url": "{{base_url}}/api/auth/register",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"farmer1\",\n  \"fullName\": {\"firstName\": \"Ram\", \"lastName\": \"Singh\"},\n  \"email\": \"farmer1@example.com\",\n  \"password\": \"password123\",\n  \"mobile\": \"9876543210\",\n  \"role\": \"farmer\"\n}"
            }
          }
        },
        {
          "name": "Register Buyer",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "url": "{{base_url}}/api/auth/register",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"buyer1\",\n  \"fullName\": {\"firstName\": \"Shyam\", \"lastName\": \"Patel\"},\n  \"email\": \"buyer1@example.com\",\n  \"password\": \"password123\",\n  \"mobile\": \"9876500000\",\n  \"role\": \"buyer\"\n}"
            }
          }
        },
        {
          "name": "Register FPO",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "url": "{{base_url}}/api/auth/register",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"fpo1\",\n  \"fullName\": {\"firstName\": \"Fpo\", \"lastName\": \"Collective\"},\n  \"email\": \"fpo1@example.com\",\n  \"password\": \"password123\",\n  \"mobile\": \"9876511111\",\n  \"role\": \"fpo\"\n}"
            }
          }
        },
        {
          "name": "Login Farmer",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "url": "{{base_url}}/api/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"farmer1@example.com\",\n  \"password\": \"password123\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const data = pm.response.json();",
                  "pm.environment.set('farmer_token', data.token);"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Login Buyer",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "url": "{{base_url}}/api/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"buyer1@example.com\",\n  \"password\": \"password123\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const data = pm.response.json();",
                  "pm.environment.set('buyer_token', data.token);"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Login FPO",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "url": "{{base_url}}/api/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"fpo1@example.com\",\n  \"password\": \"password123\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const data = pm.response.json();",
                  "pm.environment.set('fpo_token', data.token);"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Listings (Farmer)",
      "item": [
        {
          "name": "Create Listing",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{farmer_token}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": "{{base_url}}/api/listings",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"crop\": \"Wheat\",\n  \"quantityKg\": 500,\n  \"harvestDate\": \"2025-08-01\",\n  \"expectedPricePerKg\": 22,\n  \"location\": \"Village A\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const data = pm.response.json();",
                  "pm.environment.set('listingId', data.listing._id);"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Lots (FPO)",
      "item": [
        {
          "name": "Create Lot",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{fpo_token}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": "{{base_url}}/api/lots",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Wheat Lot 1\",\n  \"listingId\": [\"{{listingId}}\"]\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const data = pm.response.json();",
                  "pm.environment.set('lotId', data.lot._id);"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Close Auction",
          "request": {
            "method": "POST",
            "header": [{ "key": "Authorization", "value": "Bearer {{fpo_token}}" }],
            "url": "{{base_url}}/api/lots/{{lotId}}/close"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const data = pm.response.json();",
                  "if(data.lot.winningBid) { pm.environment.set('winningBidId', data.lot.winningBid._id); }"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Bids (Buyer)",
      "item": [
        {
          "name": "Place Bid",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{buyer_token}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": "{{base_url}}/api/bids/place-bid",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"lotId\": \"{{lotId}}\",\n  \"amount\": 12000\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const data = pm.response.json();",
                  "pm.environment.set('bidId', data.bid._id);"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Payments",
      "item": [
        {
          "name": "Initiate Payment",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{buyer_token}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": "{{base_url}}/api/payment/initiate",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"lotId\": \"{{lotId}}\",\n  \"bidId\": \"{{bidId}}\",\n  \"amount\": 500\n}"
            }
          }
        },
        {
          "name": "Verify Payment",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{buyer_token}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": "{{base_url}}/api/payment/verify",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"orderId\": \"{{razorpay_order_id}}\",\n  \"paymentId\": \"{{razorpay_payment_id}}\",\n  \"signature\": \"{{razorpay_signature}}\"\n}"
            }
          }
        },
        {
          "name": "Webhook Payment Captured",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "const crypto = require('crypto-js');",
                  "const payload = { event: 'payment.captured', payload: { payment: { entity: { id: 'pay_success123', order_id: 'order_test123', amount: 50000, currency: 'INR', status: 'captured' } } } };",
                  "const body = JSON.stringify(payload);",
                  "pm.environment.set('webhook_payload', body);",
                  "const secret = pm.environment.get('RAZORPAY_WEBHOOK_SECRET');",
                  "const signature = crypto.HmacSHA256(body, secret).toString();",
                  "pm.environment.set('webhook_signature', signature);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "x-razorpay-signature", "value": "{{webhook_signature}}" }
            ],
            "body": { "mode": "raw", "raw": "{{webhook_payload}}" },
            "url": "{{base_url}}/api/payment/webhook"
          }
        }
      ]
    }
  ],
  "variable": [
    { "key": "base_url", "value": "http://localhost:3000" },
    { "key": "farmer_token", "value": "" },
    { "key": "buyer_token", "value": "" },
    { "key": "fpo_token", "value": "" },
    { "key": "token", "value": "" },
    { "key": "listingId", "value": "" },
    { "key": "lotId", "value": "" },
    { "key": "bidId", "value": "" },
    { "key": "winningBidId", "value": "" },
    { "key": "orderId", "value": "" },
    { "key": "razorpay_order_id", "value": "" },
    { "key": "razorpay_payment_id", "value": "" },
    { "key": "razorpay_signature", "value": "" },
    { "key": "RAZORPAY_WEBHOOK_SECRET", "value": "arsh@Razorpay123" }
  ]
}
